<%-include("../layouts/checkoutHeader.ejs")%>

<style>
    @media (max-width: 991px) {
        #mobile-menu-offcanvas {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: #fff;
            transition: right 0.3s ease-in-out;
            z-index: 9999;
        }
    
        #mobile-menu-offcanvas.offcanvas-open {
            right: 0;
        }
    
        .offcanvas-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9998;
        }
    
        .offcanvas-open + .offcanvas-overlay {
            display: block;
        }
    }
    </style>
    <style>
     .order_table {
  width: 100%;
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

th, td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}

th {
  background-color: #f2f2f2;
  font-weight: bold;
}

.product-image {
  width: 100px;
  height: auto;
}

.discounted-price {
  color: #e53935;
}

@media screen and (max-width: 768px) {
  table, thead, tbody, th, td, tr {
    display: block;
  }

  thead {
    display: none;
  }

  tr {
    margin-bottom: 15px;
    border: 1px solid #ccc;
    padding: 10px;
  }

  td {
    border: none;
    position: relative;
    padding: 10px 0;
    text-align: left;
  }

  td:before {
    content: attr(data-label);
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
  }

  .product-image {
    width: 100%;
    max-width: 200px;
    margin: 0 auto;
    display: block;
  }
}
    </style>


<style>
    .address-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    position: relative;
}

.address-header {
    margin-bottom: 10px;
}

.address-type {
    font-weight: bold;
    color: #4a4a4a;
}

.address-body {
    margin-bottom: 15px;
}

.address-radio {
    margin-right: 10px;
}

.address-body strong {
    display: block;
    margin-bottom: 5px;
}

.address-body span {
    display: block;
    color: #666;
    margin-bottom: 5px;
}

.address-actions {
    display: flex;
    justify-content: flex-end;
    border-top: 1px solid #e0e0e0;
    padding-top: 10px;
}

.action-link {
    text-decoration: none;
    padding: 5px 10px;
    margin-left: 10px;
    border-radius: 4px;
    font-size: 14px;
}

.edit-address {
    color: #4285f4;
    border: 1px solid #4285f4;
}

.delete-address {
    color: #ea4335;
    border: 1px solid #ea4335;
}
</style>
    
    
    <!-- Start Header Area -->
    <header class="header-section d-none d-xl-block">
        <div class="header-wrapper">
            <div class="header-bottom header-bottom-color--golden section-fluid sticky-header sticky-color--golden">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12 d-flex align-items-center justify-content-between">
                            <!-- Start Header Logo -->
                            <div class="header-logo">
                                <div class="logo">
                                    <a href="/home"><img src="assets/images/logo/logo_black.png" alt=""></a>
                                </div>
                            </div>
                            <!-- End Header Logo -->

                            <!-- Start Header Main Menu -->
                            <div class="main-menu menu-color--black menu-hover-color--golden">
                                <nav>
                                    <ul>
                                        <li class="has-dropdown">
                                            <a class="active main-menu-link" href="/home">Home </a>
                                           
                                        </li>
                                        <li class="has-dropdown has-megaitem">
                                            <a href="/productList">Shop </a>
                                            <!-- Mega Menu -->
                                           
                                        </li>
                                        
                                        <li>
                                            <a href="/about">About Us</a>
                                        </li>
                                        <li>
                                            <a href="/contact">Contact Us</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                            <!-- End Header Main Menu Start -->

                            <!-- Start Header Action Link -->
                            <ul class="header-action-link action-color--black action-hover-color--golden">
                                
                            </ul>
                            <!-- End Header Action Link -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- Start Header Area -->

    <!-- Start Mobile Header -->
    <div class="mobile-header mobile-header-bg-color--golden section-fluid d-lg-block d-xl-none">
        <div class="container">
            <div class="row">
                <div class="col-12 d-flex align-items-center justify-content-between">
                    <!-- Start Mobile Left Side -->
                    <div class="mobile-header-left">
                        <ul class="mobile-menu-logo">
                            <li>
                                <a href="/home">
                                    <div class="logo">
                                        <img src="assets/images/logo/logo_black.png" alt="">
                                    </div>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!-- End Mobile Left Side -->

                    <!-- Start Mobile Right Side -->
                    <div class="mobile-right-side">
                        <ul class="header-action-link action-color--black action-hover-color--golden">
                            
                            <li>
                                <a href="#mobile-menu-offcanvas" class="offcanvas-toggle offside-menu">
                                    <i class="icon-menu"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!-- End Mobile Right Side -->
                </div>
            </div>
        </div>
    </div>
    <!-- End Mobile Header -->

    <!--  Start Offcanvas Mobile Menu Section -->
    <div id="mobile-menu-offcanvas" class="offcanvas offcanvas-rightside offcanvas-mobile-menu-section">
        <!-- Start Offcanvas Header -->
        <div class="offcanvas-header text-right">
            <button class="offcanvas-close"><i class="ion-android-close"></i></button>
        </div> <!-- End Offcanvas Header -->
        <!-- Start Offcanvas Mobile Menu Wrapper -->
        <div class="offcanvas-mobile-menu-wrapper">
            <!-- Start Mobile Menu  -->
            <div class="mobile-menu-bottom">
                <!-- Start Mobile Menu Nav -->
                <div class="offcanvas-menu">
                    <ul>
                        <li class="has-dropdown">
                            <a class="active main-menu-link" href="/home">Home <i
                                    ></i></a>
                        </li>
                        <li class="has-dropdown has-megaitem">
                            <a href="/productList">Shop</a>
                            <!-- Mega Menu -->
                            
                        </li>
                        <li class="">
                            <a href="/about">ABOUT </a>
                        </li>
                        <li>
                            <a href="/contact">Contact Us</a>
                        </li>
                    </ul>
                </div> <!-- End Mobile Menu Nav -->
            </div> <!-- End Mobile Menu -->

            <!-- Start Mobile contact Info -->
            <div class="mobile-contact-info">
                <div class="logo">
                    <a href="/home"><img src="assets/images/logo/logo_white.png" alt=""></a>
                </div>

                
            </div>
            <!-- End Mobile contact Info -->

        </div> <!-- End Offcanvas Mobile Menu Wrapper -->
    </div> <!-- ...:::: End Offcanvas Mobile Menu Section:::... -->

    <!-- Start Offcanvas Mobile Menu Section -->
    <div id="offcanvas-about" class="offcanvas offcanvas-rightside offcanvas-mobile-about-section">
        <!-- Start Offcanvas Header -->
        <div class="offcanvas-header text-right">
            <button class="offcanvas-close"><i class="ion-android-close"></i></button>
        </div> <!-- End Offcanvas Header -->
        <!-- Start Offcanvas Mobile Menu Wrapper -->
        <!-- Start Mobile contact Info -->
        <div class="mobile-contact-info">
            <div class="logo">
                <a href="index.html"><img src="assets/images/logo/logo_white.png" alt=""></a>
            </div>

            <address class="address">
                <span>Address: Your address goes here.</span>
                <span>Call Us: 0123456789, 0123456789</span>
                <span>Email: demo@example.com</span>
            </address>

            <ul class="social-link">
                <li><a href="#"><i class="fa fa-facebook"></i></a></li>
                <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                <li><a href="#"><i class="fa fa-instagram"></i></a></li>
                <li><a href="#"><i class="fa fa-linkedin"></i></a></li>
            </ul>

            <ul class="user-link">
                <li><a href="wishlist.html">Wishlist</a></li>
                <li><a href="cart.html">Cart</a></li>
                <li><a href="checkout.html">Checkout</a></li>
            </ul>
        </div>
        <!-- End Mobile contact Info -->
    </div> <!-- ...:::: End Offcanvas Mobile Menu Section:::... -->

    <!-- Start Offcanvas Addcart Section -->
    <div id="offcanvas-add-cart" class="offcanvas offcanvas-rightside offcanvas-add-cart-section">
        <!-- Start Offcanvas Header -->
        <div class="offcanvas-header text-right">
            <button class="offcanvas-close"><i class="ion-android-close"></i></button>
        </div> <!-- End Offcanvas Header -->

        <!-- Start  Offcanvas Addcart Wrapper -->
        <div class="offcanvas-add-cart-wrapper">
            <h4 class="offcanvas-title">Shopping Cart</h4>
            <ul class="offcanvas-cart">
                <li class="offcanvas-cart-item-single">
                    <div class="offcanvas-cart-item-block">
                        <a href="#" class="offcanvas-cart-item-image-link">
                            <img src="assets/images/product/default/home-1/default-1.jpg" alt=""
                                class="offcanvas-cart-image">
                        </a>
                        <div class="offcanvas-cart-item-content">
                            <a href="#" class="offcanvas-cart-item-link">Car Wheel</a>
                            <div class="offcanvas-cart-item-details">
                                <span class="offcanvas-cart-item-details-quantity">1 x </span>
                                <span class="offcanvas-cart-item-details-price">$49.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="offcanvas-cart-item-delete text-right">
                        <a href="#" class="offcanvas-cart-item-delete"><i class="fa fa-trash-o"></i></a>
                    </div>
                </li>
                <li class="offcanvas-cart-item-single">
                    <div class="offcanvas-cart-item-block">
                        <a href="#" class="offcanvas-cart-item-image-link">
                            <img src="assets/images/product/default/home-2/default-1.jpg" alt=""
                                class="offcanvas-cart-image">
                        </a>
                        <div class="offcanvas-cart-item-content">
                            <a href="#" class="offcanvas-cart-item-link">Car Vails</a>
                            <div class="offcanvas-cart-item-details">
                                <span class="offcanvas-cart-item-details-quantity">3 x </span>
                                <span class="offcanvas-cart-item-details-price">$500.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="offcanvas-cart-item-delete text-right">
                        <a href="#" class="offcanvas-cart-item-delete"><i class="fa fa-trash-o"></i></a>
                    </div>
                </li>
                <li class="offcanvas-cart-item-single">
                    <div class="offcanvas-cart-item-block">
                        <a href="#" class="offcanvas-cart-item-image-link">
                            <img src="assets/images/product/default/home-3/default-1.jpg" alt=""
                                class="offcanvas-cart-image">
                        </a>
                        <div class="offcanvas-cart-item-content">
                            <a href="#" class="offcanvas-cart-item-link">Shock Absorber</a>
                            <div class="offcanvas-cart-item-details">
                                <span class="offcanvas-cart-item-details-quantity">1 x </span>
                                <span class="offcanvas-cart-item-details-price">$350.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="offcanvas-cart-item-delete text-right">
                        <a href="#" class="offcanvas-cart-item-delete"><i class="fa fa-trash-o"></i></a>
                    </div>
                </li>
            </ul>
            <div class="offcanvas-cart-total-price">
                <span class="offcanvas-cart-total-price-text">Subtotal:</span>
                <span class="offcanvas-cart-total-price-value">$170.00</span>
            </div>
            <ul class="offcanvas-cart-action-button">
                <li><a href="cart.html" class="btn btn-block btn-golden">View Cart</a></li>
                <li><a href="compare.html" class=" btn btn-block btn-golden mt-5">Checkout</a></li>
            </ul>
        </div> <!-- End  Offcanvas Addcart Wrapper -->

    </div> <!-- End  Offcanvas Addcart Section -->

    <!-- Start Offcanvas Mobile Menu Section -->
    <div id="offcanvas-wishlish" class="offcanvas offcanvas-rightside offcanvas-add-cart-section">
        <!-- Start Offcanvas Header -->
        <div class="offcanvas-header text-right">
            <button class="offcanvas-close"><i class="ion-android-close"></i></button>
        </div> <!-- ENd Offcanvas Header -->

        <!-- Start Offcanvas Mobile Menu Wrapper -->
        <div class="offcanvas-wishlist-wrapper">
            <h4 class="offcanvas-title">Wishlist</h4>
            <ul class="offcanvas-wishlist">
                <li class="offcanvas-wishlist-item-single">
                    <div class="offcanvas-wishlist-item-block">
                        <a href="#" class="offcanvas-wishlist-item-image-link">
                            <img src="assets/images/product/default/home-1/default-1.jpg" alt=""
                                class="offcanvas-wishlist-image">
                        </a>
                        <div class="offcanvas-wishlist-item-content">
                            <a href="#" class="offcanvas-wishlist-item-link">Car Wheel</a>
                            <div class="offcanvas-wishlist-item-details">
                                <span class="offcanvas-wishlist-item-details-quantity">1 x </span>
                                <span class="offcanvas-wishlist-item-details-price">$49.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="offcanvas-wishlist-item-delete text-right">
                        <a href="#" class="offcanvas-wishlist-item-delete"><i class="fa fa-trash-o"></i></a>
                    </div>
                </li>
                <li class="offcanvas-wishlist-item-single">
                    <div class="offcanvas-wishlist-item-block">
                        <a href="#" class="offcanvas-wishlist-item-image-link">
                            <img src="assets/images/product/default/home-2/default-1.jpg" alt=""
                                class="offcanvas-wishlist-image">
                        </a>
                        <div class="offcanvas-wishlist-item-content">
                            <a href="#" class="offcanvas-wishlist-item-link">Car Vails</a>
                            <div class="offcanvas-wishlist-item-details">
                                <span class="offcanvas-wishlist-item-details-quantity">3 x </span>
                                <span class="offcanvas-wishlist-item-details-price">$500.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="offcanvas-wishlist-item-delete text-right">
                        <a href="#" class="offcanvas-wishlist-item-delete"><i class="fa fa-trash-o"></i></a>
                    </div>
                </li>
                <li class="offcanvas-wishlist-item-single">
                    <div class="offcanvas-wishlist-item-block">
                        <a href="#" class="offcanvas-wishlist-item-image-link">
                            <img src="assets/images/product/default/home-3/default-1.jpg" alt=""
                                class="offcanvas-wishlist-image">
                        </a>
                        <div class="offcanvas-wishlist-item-content">
                            <a href="#" class="offcanvas-wishlist-item-link">Shock Absorber</a>
                            <div class="offcanvas-wishlist-item-details">
                                <span class="offcanvas-wishlist-item-details-quantity">1 x </span>
                                <span class="offcanvas-wishlist-item-details-price">$350.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="offcanvas-wishlist-item-delete text-right">
                        <a href="#" class="offcanvas-wishlist-item-delete"><i class="fa fa-trash-o"></i></a>
                    </div>
                </li>
            </ul>
            <ul class="offcanvas-wishlist-action-button">
                <li><a href="#" class="btn btn-block btn-golden">View wishlist</a></li>
            </ul>
        </div> <!-- End Offcanvas Mobile Menu Wrapper -->

    </div> <!-- End Offcanvas Mobile Menu Section -->

    <!-- Start Offcanvas Search Bar Section -->
    <div id="search" class="search-modal">
        <button type="button" class="close">×</button>
        <form>
            <input type="search" placeholder="type keyword(s) here" />
            <button type="submit" class="btn btn-lg btn-golden">Search</button>
        </form>
    </div>
    <!-- End Offcanvas Search Bar Section -->

    <!-- Offcanvas Overlay -->
    <div class="offcanvas-overlay"></div>

    <!-- ...:::: Start Breadcrumb Section:::... -->
     <!-- ...:::: End Breadcrumb Section:::... -->

    <!-- ...:::: Start Checkout Section:::... -->
    <div class="checkout-section">
        <div class="container">
          
            <!-- Start User Details Checkout Form -->
            <div class="checkout_form" data-aos="fade-up" data-aos-delay="400">
                <div class="row">
                    <div class="">
                       
                            <h3>Delivery Address</h3>
                           
                            <div class="col-sm-12 col-md-9 col-lg-9">
                                <!-- Tab panes -->
                                <div class="tab-content dashboard_content" data-aos="fade-up" data-aos-delay="200">
                                    
                                    <button id="toggle-form-btn" class="btn btn-primary">Add New Address +</button>
                                    
                                    <!-- Form Container (initially hidden) -->
                                    <div id="form-container" style="display: none;">
                                        <h3>Add New Address</h3>
                                        <form action="/verifyAddress/<%=user._id%>" method="post"  id="accountDetailsForm">
                                            
                                            <input type="hidden" id="user_id" value="<%=user._id%>">
                                            
                                            
                                            <div class="default-form-box mb-20">
                                                <label for="">Name</label>
                                                <input type="text" placeholder="Name" name="name">
                                                <p style="color: red;"></p> <!-- Error message placeholder -->
                                            </div>
                                
                                            <div class="default-form-box mb-20">
                                                <label for="">Phone</label>
                                                <input type="text" placeholder="10 digit mobile number" name="phone">
                                                <p style="color: red;"></p> <!-- Error message placeholder -->
                                            </div>
                                
                                            <div class="default-form-box mb-20">
                                                <label for="">Pincode</label>
                                                <input type="text" placeholder="Pincode" name="pincode">
                                                <p style="color: red;"></p> <!-- Error message placeholder -->
                                            </div>
                                
                                            <div class="default-form-box mb-20">
                                                <label for="">Locality</label>
                                                <input type="text" placeholder="Locality" name="locality">
                                                <p style="color: red;"></p> <!-- Error message placeholder -->
                                            </div>
                                
                                            <div class="default-form-box mb-20">
                                                <label for="">Address (Area and Street)</label>
                                                <input type="text" placeholder="Address (Area and Street)" name="address">
                                                <p style="color: red;"></p> <!-- Error message placeholder -->
                                            </div>
                                
                                            <div class="default-form-box mb-20">
                                                <label for="">City/District/Town</label>
                                                <input type="text" placeholder="City/District/Town" name="city">
                                                <p style="color: red;"></p> <!-- Error message placeholder -->
                                            </div>
                                
                                            <div class="default-form-box mb-20">
                                                <label for="">State</label>
                                                <input type="text" placeholder="State" name="state">
                                                <p style="color: red;"></p> <!-- Error message placeholder -->
                                            </div>
                                
                                            <div class="default-form-box mb-20">
                                                <label for="">Landmark (Optional)</label>
                                                <input type="text" placeholder="Landmark (Optional)" name="landmark">
                                                <p style="color: red;"></p> <!-- Error message placeholder -->
                                            </div>
                                
                                            <div class="default-form-box mb-20">
                                                <label for="">Alternate Phone (Optional)</label>
                                                <input type="text" placeholder="Alternate Phone (Optional)" name="alternatePhone">
                                                <p style="color: red;"></p> <!-- Error message placeholder -->
                                            </div>
                                
                                            <div class="default-form-box mb-20">
                                                <label>Address Type</label>
                                                <div class="input-radio">
                                                    <span class="custom-radio"><input type="radio" value="home" name="addressType" > Home.</span>
                                                    <span class="custom-radio"><input type="radio" value="work" name="addressType" > Work.</span>
                                                </div>
                                            </div>
                                
                                            <div class="save_button mt-3">
                                                <button class="btn btn-md btn-black-default-hover" type="submit">Add New Address</button>
                                            </div>
                                        </form>
                                    </div>
            
            
            
                                    
                                    
                                    
                                </div>
                            <form action="/placeOrder" method="post">
                                
                                <% user.addressess.forEach((address, index) => { %>
                                    <div class="address-card">
                                        <div class="address-header">
                                            <span class="address-type"><%= address.addressType %></span>
                                        </div>
                                        
                                        <div class="address-body"> 
                                            <input type="radio" class="address-radio" name="selectedAddress" id="address<%= index %>" value="<%= address._id %>" 
                                            <% if (index === 0) { %> checked <% } %> >                                         
                                            <strong><%= address.name %></strong>
                                            <span><%= address.phone %></span>
                                            <p>
                                                <%= address.address %>, <%= address.locality %>,<br>
                                                <%= address.city %>, <%= address.state %> - <strong><%= address.pincode %></strong>
                                            </p>
                                        </div>
                                
                                        <div class="address-actions">
                                            <a href="/delivery/address/edit/<%= address._id %>" class="action-link edit-address">Edit</a>
                                            <a href="/delivery/address/delete/<%= address._id %>" class="action-link delete-address">Delete</a>
                                        </div>
                                    </div>
                                <% }) %>
                                
                                
                            </div>
                        
                    </div>
                    <div class="">
                       
                            <h3>Order Summary  </h3>
                            <div class="order_table">
                                <table>
                                  <thead>
                                    <tr>
                                      <th>Product Image</th>
                                      <th>Product Name</th>
                                      <th>Quantity</th>
                                      <th>Price</th> 
                                      <th>Total</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    <% items.forEach((item) => { %>
                                      <tr>
                                        <td data-label="Product Image">
                                          <img src="<%= item.variant.images[0].url %>" alt="Product Image" class="product-image">
                                        </td>
                                        <td data-label="Product Name">
                                          <span class="product-name"><%= item.product.name %></span>
                                        </td>
                                        <td data-label="Quantity">
                                          <span class="product-quantity"><%= item.quantity %></span>
                                        </td>
                                        <td data-label="Price">
                                          <% if (item.product.offer && item.product.offer.isActive && 
                                                new Date() >= new Date(item.product.offer.startDate) && 
                                                new Date() <= new Date(item.product.offer.endDate)) { %>
                                            <span class="discounted-price">Rs.<%= item.price.toFixed(2) %></span>
                                          <% } else { %>
                                            <span class="product-price">Rs.<%= item.price.toFixed(2) %></span>
                                          <% } %>
                                        </td>
                                        <td data-label="Total">
                                          <span class="product-total">Rs.<%= (item.price * item.quantity).toFixed(2) %></span>
                                        </td>
                                      </tr>
                                    <% }) %>
                                  </tbody>
                                </table>
                              </div>
                              
                              <!-- Hidden inputs -->
                              <% items.forEach((item, index) => { %>
                                <input type="hidden" name="items[<%= index %>][productId]" value="<%= item.productId %>">
                                <input type="hidden" name="items[<%= index %>][varientId]" value="<%= item.varientId %>">
                                <input type="hidden" name="items[<%= index %>][productName]" value="<%= item.product.name %>">
                                <input type="hidden" name="items[<%= index %>][quantity]" value="<%= item.quantity %>">
                                <input type="hidden" name="items[<%= index %>][price]" value="<%= item.price %>">
                                <input type="hidden" name="items[<%= index %>][total]" value="<%= item.price * item.quantity %>">
                                <input type="hidden" name="items[<%= index %>][image]" value="<%= item.variant.images[0].url %>">
                              <% }) %>
                            <div class="payment_method" style="display: flex;">
                                <div class="col-lg-6 col-md-6">
                                    <div class="coupon_code left" data-aos="fade-up" data-aos-delay="200">
                                        <h3>Coupon</h3>
                                        
                                        <div class="coupon_inner">
                                            <button class="btn btn-primary mt-3" type="button" data-toggle="modal" data-target="#couponModal">View Coupons</button>
                                            <p>Enter your coupon code if you have one.</p>
                                            <input class="mb-2" placeholder="Coupon code" type="text">
                                            <button type="submit" class="btn btn-md btn-golden">Apply coupon</button>
                                            <p id="couponErrorMessage" style="color: red;"></p>
                                        
                                        </div>
                                    </div>
                                </div>
                               



                                <div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <ul id="couponList" class="list-group">
                                                    <!-- Coupons will be dynamically loaded here -->
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                
                           
                                
                                
                        </div>

                        <div class="col-lg-6 col-md-6">
                            <div class="coupon_code right" data-aos="fade-up" data-aos-delay="400">
                                <h3>Cart Totals</h3>
                                <div class="coupon_inner">
                                    <!-- Actual MRP Section -->
                                    <div class="cart_subtotal">
                                        <p>MRP</p>
                                        <p class="cart_amount" id="cartActualMRP">Rs.<%=actualMrp.toFixed(2)%></p>
                                        <input type="hidden" name="actualMrp" value="<%=actualMrp.toFixed(2)%>">
                                    </div>
                                    
                                    <!-- Offer Discount Section -->
                                    <%if(offerDiscount){%>

                                   
                                    <div class="cart_subtotal">
                                        <p>Offer Discount</p>
                                        <p style="color: #388e3c;" class="cart_amount" id="cartOfferDiscount">- Rs.<%=offerDiscount.toFixed(2)%></p>
                                        <input type="hidden" name="offerDiscount" value="<%=offerDiscount.toFixed(2)%>">
                                    </div>
                                    <%}%>
                        
                                    <!-- Subtotal Section -->
                                    <div class="cart_subtotal">
                                        <p>Subtotal</p>
                                        <p class="cart_amount" id="cartSubtotal">Rs.<%=subtotal.toFixed(2)%></p>
                                        <input type="hidden" name="subtotal" value="<%=subtotal.toFixed(2)%>">
                                    </div>

                                    <!-- Coupon Applied Section -->
                                    <div class="cart_subtotal" id="discountSection" style="display:none;">
                                        <p>Coupon Applied (Discount)</p>
                                        <p style="color: #388e3c;" class="cart_amount" id="cartDiscount">Rs.0.00</p>
                                    </div>
                        
                                    <!-- Shipping Section -->
                                    <div class="cart_subtotal">
                                        <p>Shipping</p>
                                        <% if (total > 1000) { %>
                                            <p class="cart_amount">Free Delivery</p>
                                        <% } else { %>
                                            <p class="cart_amount">+Rs.100.00</p>
                                        <% } %>
                                    </div>
                                    <hr style="border: 1px solid #ddd; margin: 20px 0;">
                                    

                            
                                    <!-- Final Total Section -->
                                    <div class="cart_subtotal">
                                        <p>Total</p>
                                        <p class="cart_amount" id="cartTotal">Rs.<%=total.toFixed(2)%></p>
                                        <input type="hidden" name="totalAmount" value="<%=total%>">
                                    </div>
                                </div>
                            </div>
                        </div>

                        




                          
                        
                            <!-- Second Payment Method: Net Banking -->
                            
                        
                            <!-- Third Payment Method: Other UPI Apps -->
                            
                        
                            <!-- Fourth Payment Method: EMI Options -->
                            <div class="panel-default">
                                <label class="checkbox-default" for="currencyWallet" data-bs-toggle="collapse" data-bs-target="#methodWallet">
                                    <input type="radio" id="currencyWallet" name="paymentMethod" value="wallet">
                                    <span>Wallet (Available Balance - Rs.<%= user.walletBalance.toFixed(2) %>)</span>
                                </label>
                                
                            </div>
                            <p id="walletErrorMessage" style="color:red; display:none;">Insufficient wallet balance.</p> 

                        
                            <!-- Fifth Payment Method: Cash on Delivery -->
                            <div class="panel-default">
                                <label class="checkbox-default" for="currencyCod" data-bs-toggle="collapse" data-bs-target="#methodCod">
                                    <input type="radio" id="currencyCod" name="paymentMethod" value="cod" 
                                        <%= total > 1000 ? 'disabled' : '' %> >
                                        <% if (total > 1000) { %>
                                            <span style="color: red; font-size: 14px;">Cash on Delivery ( Cash on Delivery <br> is not available for orders above ₹1000).</span>
                                        <% }else{%>
                                            <span>Cash on Delivery</span>
                                        <%} %>
                                        
                                  
                                </label>
                                
                            </div>
                           
                           


                            <div class="panel-default">
                                <label class="checkbox-default" for="razorpay">
                                  <input type="radio" id="razorpay" name="paymentMethod" value="razorpay">
                                  <span>Pay with Razorpay</span>
                                </label>
                              </div>
                        
                            <div class="order_button pt-3">
                              <button class="btn btn-md btn-black-default-hover" type="submit">Place your
                                    Order</button>
                            </div>
                       
                    </div>
                </form>
                </div>
            </div> <!-- Start User Details Checkout Form -->
        </div>
    </div><!-- ...:::: End Checkout Section:::... -->

    <!-- Start Footer Section -->
    <footer class="footer-section footer-bg section-top-gap-100">
        <div class="footer-wrapper">
            <!-- Start Footer Top -->
            <div class="footer-top">
                <div class="container">
                    <div class="row mb-n6">
                        <div class="col-lg-3 col-sm-6 mb-6">
                            <!-- Start Footer Single Item -->
                            <div class="footer-widget-single-item footer-widget-color--golden" data-aos="fade-up"
                                data-aos-delay="0">
                                <h5 class="title">INFORMATION</h5>
                                <ul class="footer-nav">
                                    <li><a href="#">Delivery Information</a></li>
                                    <li><a href="#">Terms & Conditions</a></li>
                                    <li><a href="contact-us.html">Contact</a></li>
                                    <li><a href="#">Returns</a></li>
                                </ul>
                            </div>
                            <!-- End Footer Single Item -->
                        </div>
                        <div class="col-lg-3 col-sm-6 mb-6">
                            <!-- Start Footer Single Item -->
                            <div class="footer-widget-single-item footer-widget-color--golden" data-aos="fade-up"
                                data-aos-delay="200">
                                <h5 class="title">MY ACCOUNT</h5>
                                <ul class="footer-nav">
                                    <li><a href="my-account.html">My account</a></li>
                                    <li><a href="wishlist.html">Wishlist</a></li>
                                    <li><a href="privacy-policy.html">Privacy Policy</a></li>
                                    <li><a href="faq.html">Frequently Questions</a></li>
                                    <li><a href="#">Order History</a></li>
                                </ul>
                            </div>
                            <!-- End Footer Single Item -->
                        </div>
                        <div class="col-lg-3 col-sm-6 mb-6">
                            <!-- Start Footer Single Item -->
                            <div class="footer-widget-single-item footer-widget-color--golden" data-aos="fade-up"
                                data-aos-delay="400">
                                <h5 class="title">CATEGORIES</h5>
                                <ul class="footer-nav">
                                    <li><a href="#">Decorative</a></li>
                                    <li><a href="#">Kitchen utensils</a></li>
                                    <li><a href="#">Chair & Bar stools</a></li>
                                    <li><a href="#">Sofas and Armchairs</a></li>
                                    <li><a href="#">Interior lighting</a></li>
                                </ul>
                            </div>
                            <!-- End Footer Single Item -->
                        </div>
                        <div class="col-lg-3 col-sm-6 mb-6">
                            <!-- Start Footer Single Item -->
                            <div class="footer-widget-single-item footer-widget-color--golden" data-aos="fade-up"
                                data-aos-delay="600">
                                <h5 class="title">ABOUT US</h5>
                                <div class="footer-about">
                                    <p>We are a team of designers and developers that create high quality Magento,
                                        Prestashop, Opencart.</p>

                                    <address class="address">
                                        <span>Address: Your address goes here.</span>
                                        <span>Email: demo@example.com</span>
                                    </address>
                                </div>
                            </div>
                            <!-- End Footer Single Item -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Footer Top -->

            <!-- Start Footer Center -->
            <div class="footer-center">
                <div class="container">
                    <div class="row mb-n6">
                        <div class="col-xl-3 col-lg-4 col-md-6 mb-6">
                            <div class="footer-social" data-aos="fade-up" data-aos-delay="0">
                                <h4 class="title">FOLLOW US</h4>
                                <ul class="footer-social-link">
                                    <li><a href="#"><i class="fa fa-facebook"></i></a></li>
                                    <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                                    <li><a href="#"><i class="fa fa-instagram"></i></a></li>
                                    <li><a href="#"><i class="fa fa-linkedin"></i></a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-xl-7 col-lg-6 col-md-6 mb-6">
                            <div class="footer-newsletter" data-aos="fade-up" data-aos-delay="200">
                                <h4 class="title">DON'T MISS OUT ON THE LATEST</h4>
                                <div class="form-newsletter">
                                    <form action="#" method="post">
                                        <div class="form-fild-newsletter-single-item input-color--golden">
                                            <input type="email" placeholder="Your email address..." required>
                                            <button type="submit">SUBSCRIBE!</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Start Footer Center -->

            <!-- Start Footer Bottom -->
            <div class="footer-bottom">
                <div class="container">
                    <div
                        class="row justify-content-between align-items-center align-items-center flex-column flex-md-row mb-n6">
                        <div class="col-auto mb-6">
                            <div class="footer-copyright">
                                <p class="copyright-text">&copy; 2021 <a href="index.html">therankme</a>. Made with <i
                                        class="fa fa-heart text-danger"></i> by <a href="https://therankme.com/"
                                        target="_blank">therankme</a> </p>

                            </div>
                        </div>
                        <div class="col-auto mb-6">
                            <div class="footer-payment">
                                <div class="image">
                                    <img src="assets/images/company-logo/payment.png" alt="">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Start Footer Bottom -->
        </div>
    </footer>
    <!-- End Footer Section -->

    <!-- material-scrolltop button -->
    <button class="material-scrolltop" type="button"></button>

    <!-- Start Modal Add cart -->
    <div class="modal fade" id="modalAddcart" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog  modal-dialog-centered modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col text-right">
                                <button type="button" class="close modal-close" data-bs-dismiss="modal"
                                    aria-label="Close">
                                    <span aria-hidden="true"> <i class="fa fa-times"></i></span>
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-7">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="modal-add-cart-product-img">
                                            <img class="img-fluid"
                                                src="assets/images/product/default/home-1/default-1.jpg" alt="">
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="modal-add-cart-info"><i class="fa fa-check-square"></i>Added to cart
                                            successfully!</div>
                                        <div class="modal-add-cart-product-cart-buttons">
                                            <a href="cart.html">View Cart</a>
                                            <a href="checkout.html">Checkout</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-5 modal-border">
                                <ul class="modal-add-cart-product-shipping-info">
                                    <li> <strong><i class="icon-shopping-cart"></i> There Are 5 Items In Your
                                            Cart.</strong></li>
                                    <li> <strong>TOTAL PRICE: </strong> <span>$187.00</span></li>
                                    <li class="modal-continue-button"><a href="#" data-bs-dismiss="modal">CONTINUE
                                            SHOPPING</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End Modal Add cart -->

    <!-- Start Modal Quickview cart -->
    <div class="modal fade" id="modalQuickview" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog  modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col text-right">
                                <button type="button" class="close modal-close" data-bs-dismiss="modal"
                                    aria-label="Close">
                                    <span aria-hidden="true"> <i class="fa fa-times"></i></span>
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="product-details-gallery-area mb-7">
                                    <!-- Start Large Image -->
                                    <div class="product-large-image modal-product-image-large swiper-container">
                                        <div class="swiper-wrapper">
                                            <div class="product-image-large-image swiper-slide img-responsive">
                                                <img src="assets/images/product/default/home-1/default-1.jpg" alt="">
                                            </div>
                                            <div class="product-image-large-image swiper-slide img-responsive">
                                                <img src="assets/images/product/default/home-1/default-2.jpg" alt="">
                                            </div>
                                            <div class="product-image-large-image swiper-slide img-responsive">
                                                <img src="assets/images/product/default/home-1/default-3.jpg" alt="">
                                            </div>
                                            <div class="product-image-large-image swiper-slide img-responsive">
                                                <img src="assets/images/product/default/home-1/default-4.jpg" alt="">
                                            </div>
                                            <div class="product-image-large-image swiper-slide img-responsive">
                                                <img src="assets/images/product/default/home-1/default-5.jpg" alt="">
                                            </div>
                                            <div class="product-image-large-image swiper-slide img-responsive">
                                                <img src="assets/images/product/default/home-1/default-6.jpg" alt="">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- End Large Image -->
                                    <!-- Start Thumbnail Image -->
                                    <div
                                        class="product-image-thumb modal-product-image-thumb swiper-container pos-relative mt-5">
                                        <div class="swiper-wrapper">
                                            <div class="product-image-thumb-single swiper-slide">
                                                <img class="img-fluid"
                                                    src="assets/images/product/default/home-1/default-1.jpg" alt="">
                                            </div>
                                            <div class="product-image-thumb-single swiper-slide">
                                                <img class="img-fluid"
                                                    src="assets/images/product/default/home-1/default-2.jpg" alt="">
                                            </div>
                                            <div class="product-image-thumb-single swiper-slide">
                                                <img class="img-fluid"
                                                    src="assets/images/product/default/home-1/default-3.jpg" alt="">
                                            </div>
                                            <div class="product-image-thumb-single swiper-slide">
                                                <img class="img-fluid"
                                                    src="assets/images/product/default/home-1/default-4.jpg" alt="">
                                            </div>
                                            <div class="product-image-thumb-single swiper-slide">
                                                <img class="img-fluid"
                                                    src="assets/images/product/default/home-1/default-5.jpg" alt="">
                                            </div>
                                            <div class="product-image-thumb-single swiper-slide">
                                                <img class="img-fluid"
                                                    src="assets/images/product/default/home-1/default-6.jpg" alt="">
                                            </div>
                                        </div>
                                        <!-- Add Arrows -->
                                        <div class="gallery-thumb-arrow swiper-button-next"></div>
                                        <div class="gallery-thumb-arrow swiper-button-prev"></div>
                                    </div>
                                    <!-- End Thumbnail Image -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="modal-product-details-content-area">
                                    <!-- Start  Product Details Text Area-->
                                    <div class="product-details-text">
                                        <h4 class="title">Nonstick Dishwasher PFOA</h4>
                                        <div class="price"><del>$70.00</del>$80.00</div>
                                    </div> <!-- End  Product Details Text Area-->
                                    <!-- Start Product Variable Area -->
                                    <div class="product-details-variable">
                                        <!-- Product Variable Single Item -->
                                        <div class="variable-single-item">
                                            <span>Color</span>
                                            <div class="product-variable-color">
                                                <label for="modal-product-color-red">
                                                    <input name="modal-product-color" id="modal-product-color-red"
                                                        class="color-select" type="radio" checked>
                                                    <span class="product-color-red"></span>
                                                </label>
                                                <label for="modal-product-color-tomato">
                                                    <input name="modal-product-color" id="modal-product-color-tomato"
                                                        class="color-select" type="radio">
                                                    <span class="product-color-tomato"></span>
                                                </label>
                                                <label for="modal-product-color-green">
                                                    <input name="modal-product-color" id="modal-product-color-green"
                                                        class="color-select" type="radio">
                                                    <span class="product-color-green"></span>
                                                </label>
                                                <label for="modal-product-color-light-green">
                                                    <input name="modal-product-color"
                                                        id="modal-product-color-light-green" class="color-select"
                                                        type="radio">
                                                    <span class="product-color-light-green"></span>
                                                </label>
                                                <label for="modal-product-color-blue">
                                                    <input name="modal-product-color" id="modal-product-color-blue"
                                                        class="color-select" type="radio">
                                                    <span class="product-color-blue"></span>
                                                </label>
                                                <label for="modal-product-color-light-blue">
                                                    <input name="modal-product-color"
                                                        id="modal-product-color-light-blue" class="color-select"
                                                        type="radio">
                                                    <span class="product-color-light-blue"></span>
                                                </label>
                                            </div>
                                        </div>
                                        <!-- Product Variable Single Item -->
                                        <div class="d-flex align-items-center flex-wrap">
                                            <div class="variable-single-item ">
                                                <span>Quantity</span>
                                                <div class="product-variable-quantity">
                                                    <input min="1" max="100" value="1" type="number">
                                                </div>
                                            </div>

                                            <div class="product-add-to-cart-btn">
                                                <a href="#" data-bs-toggle="modal" data-bs-target="#modalAddcart">Add To
                                                    Cart</a>
                                            </div>
                                        </div>
                                    </div> <!-- End Product Variable Area -->
                                    <div class="modal-product-about-text">
                                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Mollitia iste
                                            laborum ad impedit pariatur esse optio tempora sint ullam autem deleniti nam
                                            in quos qui nemo ipsum numquam, reiciendis maiores quidem aperiam, rerum vel
                                            recusandae</p>
                                    </div>
                                    <!-- Start  Product Details Social Area-->
                                    <div class="modal-product-details-social">
                                        <span class="title">SHARE THIS PRODUCT</span>
                                        <ul>
                                            <li><a href="#" class="facebook"><i class="fa fa-facebook"></i></a></li>
                                            <li><a href="#" class="twitter"><i class="fa fa-twitter"></i></a></li>
                                            <li><a href="#" class="pinterest"><i class="fa fa-pinterest"></i></a></li>
                                            <li><a href="#" class="google-plus"><i class="fa fa-google-plus"></i></a>
                                            </li>
                                            <li><a href="#" class="linkedin"><i class="fa fa-linkedin"></i></a></li>
                                        </ul>

                                    </div> <!-- End  Product Details Social Area-->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> 


    <script src="assets/js/vendor/vendor.min.js"></script>
    <script src="assets/js/plugins/plugins.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Main JS -->
    <script src="assets/js/main.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      console.log('Razorpay script loaded:', typeof Razorpay !== 'undefined');
    </script>

    <script>

        document.addEventListener('DOMContentLoaded', function() {
            const toggleFormBtn = document.getElementById('toggle-form-btn');
            const formContainer = document.getElementById('form-container');
    
            toggleFormBtn.addEventListener('click', function() {
                if (formContainer.style.display === 'none') {
                    formContainer.style.display = 'block';
                    toggleFormBtn.textContent = 'Add New Address -'; // Change button text to indicate collapse
                } else {
                    formContainer.style.display = 'none';
                    toggleFormBtn.textContent = 'Add New Address +'; // Change button text to indicate expand
                }
            });
        });
        </script>
    
       
        <script>
                document.addEventListener('DOMContentLoaded', function () {
        const accountDetailsForm = document.getElementById('accountDetailsForm');
        const userId = document.getElementById('user_id').value;
        accountDetailsForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            
            const formData = new FormData(accountDetailsForm);
            
            // Clear previous error messages
            document.querySelectorAll('.default-form-box p').forEach(p => p.innerText = "");
    
    
            
            try {
                const response = await fetch('/verifyAddress/' + userId, {
                    method: 'post',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(Object.fromEntries(formData)),
                });
    
    
    
                const result = await response.json();
                if (result.success) {
                    // Display success message using SweetAlert
                    swal.fire({
                        title: "Success!",
                        text: result.message,
                        icon: "success",
                        confirmButtonText: "OK"
                    }).then(() => {
                        window.location.reload();
                    });
                }
                 else {
                    // Display validation errors in p tags
                    
                    if (result.errors.invalidName) {
                        document.querySelector('input[name="name"]').nextElementSibling.innerText = result.errors.invalidName;
                    }
                    if (result.errors.invalidPhone) {
                        document.querySelector('input[name="phone"]').nextElementSibling.innerText = result.errors.invalidPhone;
                    }if (result.errors.invalidPincode) {
                        document.querySelector('input[name="pincode"]').nextElementSibling.innerText = result.errors.invalidPincode;
                    }
                    if (result.errors.invalidLocality) {
                        document.querySelector('input[name="locality"]').nextElementSibling.innerText = result.errors.invalidLocality;
                    }
                    if (result.errors.invalidAddress) {
                        document.querySelector('input[name="address"]').nextElementSibling.innerText = result.errors.invalidAddress;
                    }
                    if (result.errors.invalidCity) {
                        document.querySelector('input[name="city"]').nextElementSibling.innerText = result.errors.invalidCity;
                    }
                    if (result.errors.invalidState) {
                        document.querySelector('input[name="state"]').nextElementSibling.innerText = result.errors.invalidState;
                    }
                    if (result.errors.invalidLandmark) {
                        document.querySelector('input[name="landmark"]').nextElementSibling.innerText = result.errors.invalidLandmark;
                    }
                    if (result.errors.invalidAlternatePhone) {
                        document.querySelector('input[name="alternatePhone"]').nextElementSibling.innerText = result.errors.invalidAlternatePhone;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                swal.fire({
                    title: "Error!",
                    text: "An error occurred while updating account details.",
                    icon: "error",
                    button: "OK"
                });
            }
        });
    });
        </script>
            
        
    
        <script>
             $(document).ready(function () {
                const userId = document.getElementById('user_id').value;
    
            const urlParams = new URLSearchParams(window.location.search);
            const successMessage = urlParams.get('success');
            if (successMessage) {
                Swal.fire({
                    position: "center",
                    icon: "success",
                    title: successMessage,
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    window.location.href = `/checkout`; 
                    
                });
            }
        });
        </script>





    <script>
        document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded');
        
        const placeOrderForm = document.querySelector('form[action="/placeOrder"]');
        if (placeOrderForm) {
            console.log('Place order form found');
            placeOrderForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                console.log('Form submitted');
                
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                console.log('Payment method:', paymentMethod);


                if (paymentMethod === 'wallet') {
                const walletRadio = document.getElementById('currencyWallet');
                const totalAmount = parseFloat(document.querySelector('input[name="totalAmount"]').value || 0);
                const walletBalance = parseFloat('<%= user.walletBalance %>');
                const errorMessage = document.getElementById('walletErrorMessage');

                // Debug: Log total amount and wallet balance
                console.log('Total Amount:', totalAmount);
                console.log('Wallet Balance:', walletBalance);

                // Show error message if wallet balance is insufficient
                if (walletBalance < totalAmount) {
                    errorMessage.style.display = 'block'; // Show error message
                    console.log('Insufficient wallet balance. Form submission prevented.');
                    return; // Prevent submission if balance is insufficient
                } else {
                    errorMessage.style.display = 'none'; // Hide error message
                    console.log('Sufficient wallet balance. Proceeding with form submission.');
                }
            }
                
                if (paymentMethod === 'razorpay') {
                    try {
                        console.log('Sending request to /placeOrder');
                        const formData = new FormData(placeOrderForm);
                        const response = await fetch('/placeOrder', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(Object.fromEntries(formData))
                        });
                        
                        console.log('Response received');
                        const data = await response.json();
                        console.log('Parsed data:', data);
                        
    
                        if (data && data.orderId) {
                            console.log('Creating Razorpay options');
                            const options = {
                                key: data.keyId,
                                amount: data.amount,
                                currency: data.currency,
                                name: 'Swift Cart',
                                description: 'Purchase Description',
                                order_id: data.orderId,
                                handler: function (response) {
                                console.log('Payment successful:', response);
                                // Send the payment details to your server
                                fetch('/razorpay-success', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        razorpay_payment_id: response.razorpay_payment_id,
                                        razorpay_order_id: response.razorpay_order_id,
                                        razorpay_signature: response.razorpay_signature
                                    })
                                })
                                .then(res => res.json())
                                .then(data => {
                                    if (data.success) {
                                        window.location.href = `/orderSuccess?orderNumber=${data.orderNumber}`;
                                    } else {
                                        window.location.href = '/orderFailure';
                                        console.error('Error saving order:', data.error);
                                        alert('There was an error processing your order. Please contact support.');
                                    }
                                })
                               
                                .catch(error => {
                                    window.location.href = '/orderFailure';
                                    console.error('Error:', error);
                                    alert('There was an error processing your order. Please try again.');
                                });
                            },
                            
                            modal: {
                                ondismiss: function() {
                                    console.log('Razorpay modal closed');
                                    window.location.href = '/orderFailure';
                                    }
                                   
                                    
                                },
                                
                                prefill: {
                                    name: 'User Name',
                                    email: 'user@example.com',
                                    contact: '9999999999'
                                },
                                theme: {
                                    color: '#F37254'
                                }
                            };
                            var rzp1 = new Razorpay(options);

                            // Handle the failure case
                            rzp1.on('payment.failed', function (response) {
                                console.error('Payment failed:', response);
                                
                                // Optional: Log failure response details
                                console.log(response.error.code);
                                console.log(response.error.description);
                                console.log(response.error.source);
                                console.log(response.error.step);
                                console.log(response.error.reason);
                                console.log(response.error.metadata);

                                // Redirect to failure page
                                window.location.href = '/orderFailure';
                            });
                            
                            
                            console.log('Razorpay options:', options);
                            console.log('Initializing Razorpay');
                           
                            console.log('Opening Razorpay');
                               rzp1.open();
                        } else {
                            window.location.href = '/orderFailure';
                            console.error('Invalid response from server:', data);
                        }
                    } catch (error) {
                        window.location.href = '/orderFailure';
                        console.error('Error processing payment:', error);
                    }
                } else {
                    console.log('Submitting form for non-Razorpay payment');
                    placeOrderForm.submit();
                }
            });
        } else {
            console.error('Place order form not found in the DOM');
        }
    
        // Check if Razorpay script is loaded
        console.log('Razorpay script loaded:', typeof Razorpay !== 'undefined');
    });
        </script>
    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function() {
            // When the modal is opened, fetch coupons
            $('#couponModal').on('show.bs.modal', async function() {
                try {
                    const response = await fetch('/coupons'); // Adjust route if necessary
                    const coupons = await response.json();
                    const couponList = $('#couponList');
                    couponList.empty(); // Clear previous content
    
                    if (coupons.length > 0) {
                        coupons.forEach(coupon => {
                            couponList.append(`
                                <li class="list-group-item">
                                <strong>${coupon.code}</strong> - ${coupon.discount}% off, expires on ${new Date(coupon.expiryDate).toLocaleDateString()} 
                                (Min Purchase: Rs.${coupon.minPurchaseAmount})
                               </li>
                            `);
                        });
                    } else {
                        couponList.append('<li class="list-group-item">No available coupons at the moment.</li>');
                    }
                } catch (error) {
                    console.error('Error fetching coupons:', error);
                    $('#couponList').append('<li class="list-group-item text-danger">Failed to load coupons.</li>');
                }
            });
        });
    </script>










<script>
    $(document).ready(function() {
        let appliedCoupon = null;

        // Add the remove coupon button (initially hidden)
        const removeCouponBtn = $('<button>')
            .attr({
                type: 'button',
                class: 'btn btn-danger mt-2',
                id: 'removeCouponBtn'
            })
            .text('Remove Coupon')
            .insertAfter('.btn-golden')
            .hide();

        // Handle coupon submission
        $('.btn-golden').click(async function() {
            const couponCode = $('input[placeholder="Coupon code"]').val();
            const subtotal = parseFloat($('#cartSubtotal').text().replace('Rs.', '').replace('.00', '')); 
            const totalAmount = parseFloat($('input[name="totalAmount"]').val() || 0);
            
            const couponErrorMessage = $('#couponErrorMessage');
            couponErrorMessage.text('');

            if (!couponCode) {
                couponErrorMessage.text('Please enter a coupon code');
                return;
            }

            try {
                const response = await fetch('/validate-coupon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: couponCode,
                        totalAmount,
                        subtotal
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    const discountAmount = result.discountAmount || 0;
                    const newTotal = (subtotal - discountAmount).toFixed(2);
                    const discountElement = $('#cartDiscount');
                    const totalElement = $('#cartTotal');

                    if (discountAmount > 0) {
                        $('#discountSection').show();
                        discountElement.text(`Rs.-${discountAmount.toFixed(2)}`);
                    }

                    totalElement.text(`Rs.${newTotal}`);
                    $('input[name="totalAmount"]').val(newTotal);

                    if ($('input[name="discountAmount"]').length === 0) {
                        $('<input>').attr({
                            type: 'hidden',
                            name: 'discountAmount',
                            value: discountAmount
                        }).appendTo('form[action="/placeOrder"]');
                    } else {
                        $('input[name="discountAmount"]').val(discountAmount);
                    }

                    // Disable the coupon input field and hide the apply coupon button
                    $('input[placeholder="Coupon code"]').prop('disabled', true);
                    $('.btn-golden').hide();
                    removeCouponBtn.show();
                    appliedCoupon = couponCode;

                    Swal.fire({
                        icon: 'success',
                        title: 'Coupon Applied',
                        text: result.message
                    });
                } else {
                    couponErrorMessage.text(result.message);
                }
            } catch (error) {
                console.error('Error applying coupon:', error);
                couponErrorMessage.text('Failed to apply coupon. Please try again later.');
            }
        });

        // Handle coupon removal
        removeCouponBtn.click(async function() {
            try {
                const response = await fetch('/remove-coupon', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code: appliedCoupon })
                });

                const result = await response.json();

                if (response.ok) {
                    const subtotal = parseFloat($('#cartSubtotal').text().replace('Rs.', '').replace('.00', ''));
                    const newTotal = (subtotal).toFixed(2);

                    $('#discountSection').hide();
                    $('#cartTotal').text(`Rs.${newTotal}`);
                    $('input[name="totalAmount"]').val(newTotal);
                    $('input[name="discountAmount"]').val(0);

                    // Re-enable the coupon input field and show the apply coupon button
                    $('input[placeholder="Coupon code"]').prop('disabled', false);
                    $('.btn-golden').show();
                    removeCouponBtn.hide();
                    $('input[placeholder="Coupon code"]').val('');
                    appliedCoupon = null;

                    Swal.fire({
                        icon: 'success',
                        title: 'Coupon Removed',
                        text: result.message
                    });
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error removing coupon:', error);
                $('#couponErrorMessage').text('Failed to remove coupon. Please try again later.');
            }
        });
    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        var menuToggle = document.querySelector('a[href="#mobile-menu-offcanvas"]');
        var mobileMenu = document.getElementById('mobile-menu-offcanvas');
        var closeButton = mobileMenu.querySelector('.offcanvas-close');
    
        menuToggle.addEventListener('click', function(e) {
            e.preventDefault();
            mobileMenu.classList.add('offcanvas-open');
        });
    
        closeButton.addEventListener('click', function() {
            mobileMenu.classList.remove('offcanvas-open');
        });
    
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!mobileMenu.contains(e.target) && !menuToggle.contains(e.target)) {
                mobileMenu.classList.remove('offcanvas-open');
            }
        });
    });
    </script>

    <%-include("../layouts/footer.ejs")%>
